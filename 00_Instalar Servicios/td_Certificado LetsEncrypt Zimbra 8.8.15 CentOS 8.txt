Letâ€™s Encrypt Zimbra 8.8.15 CentOS 8

-dnf update
-dnf install wget

Instalando Certbot

-wget https://dl.eff.org/certbot-auto

-chmod +x certbot-auto
-mv certbot-auto /usr/local/bin

Detenemos Zimbra

-su zimbra
-zmproxyctl stop
-exit

export EMAIL="admin@ecim.co.cu"
certbot-auto certonly --standalone \
-d mta.ecim.co.cu \
-d correo.ecim.co.cu \
--preferred-challenges http \
--agree-tos \
-m $EMAIL \
--keep-until-expiring

Ver el certificado:

-ls -lh /etc/letsencrypt/live/mta.ecim.co.cu

Crear el directorio para el certificado:

-mkdir /opt/zimbra/ssl/letsencrypt
-cp /etc/letsencrypt/live/mta.ecim.co.cu/* /opt/zimbra/ssl/letsencrypt/

Vemos que todo este en orden:
-ls /opt/zimbra/ssl/letsencrypt/

Copiamos el contenido de:
https://letsencrypt.org/certs/trustid-x3-root.pem.txt

Editamos:

-nano /opt/zimbra/ssl/letsencrypt/chain.pem

Y pegamos debajo el contenido de https://letsencrypt.org/certs/trustid-x3-root.pem.txt

Establecemos permisos:

-chown -R zimbra:zimbra /opt/zimbra/ssl/letsencrypt/

Verificamos:

-ls -lha /opt/zimbra/ssl/letsencrypt/

Entramos como usuario Zimbra:

-su zimbra

Verificamos que todo este correcto:

-/opt/zimbra/bin/zmcertmgr verifycrt comm /opt/zimbra/ssl/letsencrypt/privkey.pem /opt/zimbra/ssl/letsencrypt/cert.pem /opt/zimbra/ssl/letsencrypt/chain.pem

Salimos de usuario Zimbra

-exit

Hacemos salva del certificado actual, principalmente si vamos a renovar antes de que expire el anterior

-cp -a /opt/zimbra/ssl/zimbra /opt/zimbra/ssl/zimbra.$(date "+%Y%.m%.d-%H.%M")

Copiamos al directorio de certificados de zimbra y damos permiso:

-cp /opt/zimbra/ssl/letsencrypt/privkey.pem /opt/zimbra/ssl/zimbra/commercial/commercial.key
-chown zimbra:zimbra /opt/zimbra/ssl/zimbra/commercial/commercial.key

Finalmente aplicamos el certificado nuevo:

-sudo su - zimbra -c '/opt/zimbra/bin/zmcertmgr deploycrt comm /opt/zimbra/ssl/letsencrypt/cert.pem /opt/zimbra/ssl/letsencrypt/chain.pem'

Reiniciamos los servicios de Zimbra:

-su zimbra
-zmcontrol restart

Verificamos que funcione.

