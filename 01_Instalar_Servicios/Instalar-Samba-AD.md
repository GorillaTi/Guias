Guía de:

# Samba Active Directory en Alama Linux 8.7 / Debian

## ACERCA DE:

Versión: 1.0.0

Nivel: Avanzado

Área: C.P.D.

Elaborado por: Edmundo Céspedes Ayllón

e-mail: [ed.cespedesa@gmail.com](ed.cespedesa@gmail.com)

---

## Instalación básica de servidores

Guía de instalación básica de [CentOS/AlmaLinux](https://github.com/GorillaTi/Guias/blob/main/01_Instalar_Servicios/Instalar-CentOS-AlmaLinux.md)

Guía de instalación básica de [Debian](https://github.com/GorillaTi/Guias/blob/main/01_Instalar_Servicios/Instalar-Debian.md)

## Configuración Básica del SO

### CentOS / Alma Linux

Paquetes básicos y utilidades:

```bash
yum install -y bash-completion net-tools vim nano wget
```

#### Actualización del servidor, paquetes y dependencias:

```bash
yum -y groupinstall 'Development Tools'
```

```url
wget http://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm
```

```bash
rpm -ivh epel-release-latest-7.noarch.rpm
```

```bash
yum install -y attr bind-utils docbook-style-xsl gcc gdb krb5-workstation libsemanage-python libxslt perl perl-ExtUtils-MakeMaker perl-Parse-Yapp perl-Test-Base pkgconfig policycoreutils-python python-crypto gnutls-devel libattr-devel keyutils-libs-devel libacl-devel libaio-devel libblkid-devel libxml2-devel openldap-devel pam-devel pop-devel python-devel readline-devel zlib-devel systemd-devel iniparser libldb libtalloc libtdb libtevent python-devel gnutls-devel libacl-devel openldap-devel pam-devel readline-devel krb5-devel cups-devel jansson-devel gpgme-devel libarchive-devel lmdb
```

```bash
sudo cpan JSON
```

```bash
yum install -y bind
```

```bash
yum -y update
```

#### Establecer IP fija al servidor:

```bash
nano /etc/sysconfig/network-scripts/ifcg-enp0s3
```

```shell-session
TYPE="Ethernet"
PROXY_METHOD="none"
BROWSER_ONLY="no"
BOOTPROTO="none"
DEFROUTE="yes"
IPV4_FAILURE_FATAL="no"
IPV6INIT="yes"
IPV6_AUTOCONF="yes"
IPV6_DEFROUTE="yes"
IPV6_FAILURE_FATAL="no"
IPV6_ADDR_GEN_MODE="stable-privacy"
NAME="enp3s0"
UUID="c6effd5b-1cd7-456d-9fc9-c278e1639024"
IPADDR="192.168.5.149"
GATEWAY="192.168.5.5"
PREFIX=24
DNS1="192.168.5.149"
DNS2="8.8.8.8"
DOMAIN="izz3r.lab"
DEVICE="enp3s0"
ONBOOT="yes"
```

#### Configuración de firewall y Selinux

Verificar estado de firewall:

```bash
systemctl status firewalld
```

Añadir servicios y abrir puertos en firewall para samba:

```bash
firewall-cmd --add-service={dns,kerberos,kpasswd,ldap,ldaps,samba} --permanent 
firewall-cmd --permanent --add-port=111/tcp
firewall-cmd --permanent --add-port=111/udp
firewall-cmd --permanent --add-port=53/tcp
firewall-cmd --permanent --add-port=53/udp
firewall-cmd --permanent --add-port=88/tcp
firewall-cmd --permanent --add-port=88/udp
firewall-cmd --permanent --add-port=135/tcp
firewall-cmd --permanent --add-port=137/tcp
firewall-cmd --permanent --add-port=137/udp
firewall-cmd --permanent --add-port=138/udp
firewall-cmd --permanent --add-port=139/tcp
firewall-cmd --permanent --add-port=389/tcp
firewall-cmd --permanent --add-port=389/udp
firewall-cmd --permanent --add-port=445/tcp
firewall-cmd --permanent --add-port=464/tcp
firewall-cmd --permanent --add-port=464/udp
firewall-cmd --permanent --add-port=636/tcp
firewall-cmd --permanent --add-port=1024/tcp
firewall-cmd --permanent --add-port=1024/udp
firewall-cmd --permanent --add-port=5000/tcp
firewall-cmd --permanent --add-port=5000/udp
firewall-cmd --permanent --add-port=3500/tcp
firewall-cmd --permanent --add-port=3268/tcp
firewall-cmd --permanent --add-port=3269/tcp
firewall-cmd --permanent --add-port=5353/tcp
firewall-cmd --permanent --add-port=5353/udp
firewall-cmd --permanent --add-port=32774/tcp
firewall-cmd --permanent --add-port=834/tcp 
firewall-cmd --permanent --add-port=49152/tcp
firewall-cmd --permanent --add-port=65535/tcp
```

Recargamos la configuración del servicio de firewall

```bash
firewall-cmd --reload 
```

### Debian / Ubuntu

Habilitando repositorios adicionales

```bash
sudo apt install build-essential -y
```

### Verificar nombre actual del servidor y modificar:

```bash
hostname
```

```bash
hostname -d
```

```bash
hostname -f
```

```bash
hostnamectl set-hostname [nameserver]
```

### Configurar archivo hosts y agregar el nombre del servidor:

```bash
nano /etc/hosts
```

```shell-session
127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
#::1         localhost localhost.localdomain localhost6 localhost6.localdomain6
192.168.5.149 exma.izz3r.lab exma
```

### Configurar archivo resolv.conf:

```bash
nano /etc/resolv.conf
```

```shell-session
Generated by NetworkManager

search izz3r.lab
DNS 192.168.5.149
DNS 8.8.8.8
```

```bash
chattr +i /etc/resolv.conf
```

### Configuración de Selinux (etc/selinux/config):

```bash
sestatus
```

```bash
nano /etc/selinux/config
```

```shell-session
This file controls the state of SELinux on the system.
SELINUX= can take one of these three values:
enforcing - SELinux security policy is enforced.
permissive - SELinux prints warnings instead of enforcing.
disabled - No SELinux policy is loaded.
SELINUX=disabled
SELINUXTYPE= can take one of three values:
targeted - Targeted processes are protected,
minimum - Modification of targeted policy. Only selected processes are protected.
mls - Multi Level Security protection.
SELINUXTYPE=targeted
```

```bash
reboot
```

## Instalación de Dependencias

### CentOS / Alama Linux

```bash
sudo dnf install -y docbook-style-xsl gcc gdb gnutls-devel gpgme-devel jansson-devel \
      keyutils-libs-devel krb5-workstation libacl-devel libaio-devel \
      libarchive-devel libattr-devel libblkid-devel libtasn1 libtasn1-tools \
      libxml2-devel libxslt lmdb-devel openldap-devel pam-devel perl \
      perl-ExtUtils-MakeMaker perl-Parse-Yapp popt-devel python3-cryptography \
      python3-dns python3-gpg python36-devel readline-devel rpcgen systemd-devel \
      tar zlib-devel
```

### Debian / Ubuntu

```bash
sudo apt-get install -y acl attr autoconf bind9utils bison build-essential \
  debhelper dnsutils docbook-xml docbook-xsl flex gdb libjansson-dev krb5-user \
  libacl1-dev libaio-dev libarchive-dev libattr1-dev libblkid-dev libbsd-dev \
  libcap-dev libcups2-dev libgnutls28-dev libgpgme-dev libjson-perl \
  libldap2-dev libncurses5-dev libpam0g-dev libparse-yapp-perl \
  libpopt-dev libreadline-dev nettle-dev perl perl-modules pkg-config \
  python-all-dev python-crypto python-dbg python-dev python-dnspython \
  python3-dnspython python-gpgme python3-gpgme python-markdown python3-markdown \
  python3-dev xsltproc zlib1g-dev liblmdb-dev lmdb-utils
```

```bash
sudo apt install -y krb5-kdc krb5-admin-server krb5-config krb5-user
```

> Se puede encontrar mayor información en [Paquetes de Dependencia para SAMBA](https://wiki.samba.org/index.php/Package_Dependencies_Required_to_Build_Samba)

## Compilación e instalación de samba

### Descargar de SAMBA

```url
curl -O https://download.samba.org/pub/samba/stable/samba-4.8.3.tar.gz
```

o

```url
wget https://download.samba.org/pub/samba/stable/samba-4.16.4.tar.gz
```

### Descomprimir el paquete descargado

```bash
tar -zxvf samba-4.8.3.tar.gz
```

### Testeo y configuración de las rutas de instalación de samba:

#### Configuración Básica

```bash
./config
```

#### Configuración Avanzada

```bash
./configure --prefix=/usr --localstatedir=/var --with-configdir=/etc/samba  --libdir=/usr/lib64 --with-modulesdir=/usr/lib64/samba --with-pammodulesdir=/lib64/security --with-lockdir=/var/lib/samba --with-logfilebase=/var/log/samba --with-piddir=/run/samba --with-privatedir=/etc/samba --enable-cups --with-acl-support --with-ads --with-automount --enable-fhs --with-pam --with-quotas --with-shared-modules=idmap_rid,idmap_ad,idmap_hash,idmap_adex --with-syslog --with-utmp --with-dnsupdate --with-systemd
```

o

```bash
./configure --enable-debug --enable-selftest --with-ads --with-systemd --with-winbind --prefix=/opt/samba
```

### Compilando paquete de instalación de SAMBA

#### Revisar cantidad de núcleos del procesador

```bash
nproc
```

#### Compilando SAMBA

Por defecto (puede tardar mas) 

```bash
make
```

o especificando numero de núcleos de procesador a utilizar (tarda menos)

```bash
make -j 4
```

### Instalando SAMBA

```bash
sudo make install
```

## Adicionando comando samba a `$PATH`

```bash
export PATH=/usr/local/samba/bin/:/usr/local/samba/sbin/:$PATH
```

## Crear archivo de configuración de samba

### SYSTEMD

Creamos el archivo de configuración

```bash
sudo nano /usr/lib/systemd/system/samba-ad-dc.service
```

Insertamos la configuración siguiente:

```bash
[Unit]
Description=Samba Active Directory Domain Controller
After=network.target remote-fs.target nss-lookup.target

[Service]
Type=forking
ExecStart=/usr/local/samba/sbin/samba -D
PIDFile=/usr/local/samba/var/run/samba.pid
ExecReload=/bin/kill -HUP $MAINPID

[Install]
WantedBy=multi-user.target
```

## Aprovisionando servicio de SAMBA AD

```bash
samba-tool domain provision –use-rfc2307 –interactive
```

Ejemplo de configuración

```shell-session
Realm [lastdragon.local]:
Domain [lastdragon]:
Server Role (dc, member, standalone) [dc]:
DNS backend (SAMBA_INTERNAL, BIND9_FLATFILE, BIND9_DLZ, NONE) [SAMBA_INTERNAL]:
DNS forwarder IP address (write ‘none’ to disable forwarding) [8.8.8.8]:
Administrator password:racion:
```

### Copiando la configuración de `kerberos` a `etc`

```bash
sudo cp /etc/samba/krb5.conf /etc/
```

## Administración de servicio

Reinicio del servicio

```bash
sudo systemctl restart samba-ad-dc
```

En habilitar servicio

```bash
sudo systemctl enable samba-ad-dc
```

Iniciar servicio

```bash
sudo systemctl status named-ad-dc
```

## Comando para verificación del servicio SAMBA

Revisar versión de Active Directory

```bash
samba-tool domain level show
```

Comprobar DNS en samba:

```bash
samba_dnsupdate --verbose
```

```bash
host -t A [hostname.seconddomain.firstdomain]
```

```bash
samba_upgradedns --dns-backend=BIND9_DLZ
```

```bash
samba_dnsupdate --verbose
```

## Unir cliente al dominio e instalar RSAT

En un instalación de Windows Pro configurar una IP fija, luego agregar al dominio.

Para instalar la herramientas RSAT, ejecutar Power Shell en modo administrador y ejecutar los siguientes comandos

```sh-session
Get-Command -Noun WindowsCapability
Get-WindowsCapability -Name RSAT* -Online
Get-WindowsCapability -Name RSAT* -Online | Select-Object -Property DisplayName, State
Get-WindowsCapability -Name RSAT* -Online | Add-WindowsCapability -Online
Get-WindowsCapability -Name RSAT* -Online | Select-Object -Property DisplayName, State
```

## Administración de Samba vía CLI:

Listar usuarios

```bash
samba-tool user list
```

Crear usuario

```bash
samba-tool user create nameuser
```

Eliminar usuario

```bash
samba-tool user delete nameuser
```

Asignar contraseña al usuario

```bash
samba-tool user setpassword nameuser
```

Colocar tiempo de expiracion al usuario

```bash
samba-tool user setexpiry nameuser --days=9
```

Deshabilitar un usuario

```bash
samba-tool user disable nameuser
```

Habilitar un usuario

```bash
samba-tool user enable nameuser
```

Agrupar lista de grupos

```bash
samba-tool group list
```

Listar miembros de un grupo

```bash
samba-tool group listmembers "Domain Users"
```

Adicionar usuario a un grupo

```bash
samba-tool group add namegroup
```

```bash
samba-tool group addmembers namegroup username
```

```bash
samba-tool group removemembers namegroup nameuser
```

Eliminar a un usuario de un grupo

```bash
samba-tool group delete nameuser
```

## Carpetas compartidas:

```bash
mkdir publico
```

```bash
chmod 777 /publico
```

```bash
vim /etc/samba/smb.conf
```

```shell-session
map to guest = Bad User[PUBLICO]
path = /publico/
writable = yes
guest ok = yes
guest only = yes
create mode = 0777
directory mode = 0777
```
